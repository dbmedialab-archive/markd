(function(b){var a={init:function(c){return this.each(function(){b(this).data("options",b.extend({},b.fn.markd.defaults,c));b(this).addClass("markd mousetrap");var d=b(this);var e=window.marked;var h=false;var j={};var k=d.offset();var i=b(this).data("options");var g=false;if(i.autosave&&typeof(Storage)!=="undefined"&&d.attr("data-autosave-key")!=undefined){a.open(d);g=true}if(!d.is("textarea")){var f=d.html();a.setContent(d,f.replace(/(\r\n|\n|\r)/gm,""))}e.setOptions({pedantic:i.parser.pedantic,sanitize:i.parser.sanitize});d.bind("focus",function(l){if(g){d.bind("keyup",function(){a.save(d.attr("data-autosave-key"),a.getContent(d))})}Mousetrap.bind("tab",function(){var n=a.getSelection(d);var m=a.getContent(d);m=a.insert(m,n.end,"\t");a.setContent(d,m);a.setCursor(d,n.end+1);return false});Mousetrap.bind(i.keyboardShortcuts.link,function(){var o=a.getSelection(d);var n=a.getContent(d);var m=n.substring(o.start,o.end).match(/(http|https|ftp):\/\//);if(m!=null){n=a.insert(n,o.end,")");n=a.insert(n,o.start,"[](");a.setContent(d,n);a.setCursor(d,o.start+1)}else{n=a.insert(n,o.end,"]()");n=a.insert(n,o.start,"[");a.setContent(d,n);a.setCursor(d,o.end+3)}return false});Mousetrap.bind(i.keyboardShortcuts.code,function(){var n=a.getSelection(d);var m=a.getContent(d);m=a.insert(m,n.end,"`");m=a.insert(m,n.start,"`");a.setContent(d,m);a.setCursor(d,n.end+2);return false});Mousetrap.bind(i.keyboardShortcuts.bold,function(){var n=a.getSelection(d);var m=a.getContent(d);m=a.insert(m,n.end,"__");m=a.insert(m,n.start,"__");a.setContent(d,m);a.setCursor(d,n.end+4);return false});Mousetrap.bind(i.keyboardShortcuts.italic,function(){var n=a.getSelection(d);var m=a.getContent(d);m=a.insert(m,n.end,"_");m=a.insert(m,n.start,"_");a.setContent(d,m);a.setCursor(d,n.end+2);return false});Mousetrap.bind(i.keyboardShortcuts.help,function(){window.open("http://daringfireball.net/projects/markdown/syntax","_blank");return false});Mousetrap.bind(i.keyboardShortcuts.preview,function(){if(!h){if(j.el==undefined){j=a.createPreview(i.theme);j.el.css({top:k.top,left:k.left,width:d.outerWidth(),height:d.outerHeight()});j.body.html(e(a.getContent(d)));Mousetrap.bind("esc",function(){j=a.deletePreview(j);Mousetrap.unbind("esc")})}else{j=a.deletePreview(j);Mousetrap.unbind("esc")}}return false});Mousetrap.bind(i.keyboardShortcuts.fullscreen,function(){if(!h){h=true;d.addClass("fullscreen");j=a.createPreview(i.theme);j.el.addClass("fullscreen");d.bind("keyup",function(m){j.body.html(e(a.getContent(d)))});Mousetrap.bind("esc",function(){h=false;d.removeClass("fullscreen");d.unbind("keyup");Mousetrap.unbind("esc");j=a.deletePreview(j)})}else{h=false;d.removeClass("fullscreen");d.unbind("keyup");Mousetrap.unbind("esc");j=a.deletePreview(j)}return false})});d.bind("blur",function(l){if(g){d.unbind("keyup")}Mousetrap.unbind("tab");Mousetrap.unbind(i.keyboardShortcuts.bold);Mousetrap.unbind(i.keyboardShortcuts.italic);Mousetrap.unbind(i.keyboardShortcuts.link);Mousetrap.unbind(i.keyboardShortcuts.help);Mousetrap.unbind(i.keyboardShortcuts.preview);Mousetrap.unbind(i.keyboardShortcuts.fullscreen);if(!h){j=a.deletePreview(j)}})})},getContent:function(c){if(c.is("textarea")){return c.val()}else{if(document.getElementById(c.attr("id")).innerText){var d=document.getElementById(c.attr("id")).innerText}else{var d=document.getElementById(c.attr("id")).textContent}d=d.replace(/\u00a0/g," ").replace(/&nbsp;/g," ");return d}},setContent:function(c,d){if(c.is("textarea")){c.val(d)}else{d=d.replace(/(\r\n|\n|\r)/gm,"<br>");c.html(d)}},getSelection:function(e){var d=e.selection();if(!e.is("textarea")){var c=a.getContent(e).substr(0,d.end);var f=c.match(/(\r\n|\n|\r)/gm);if(f!=null){var g=a.getContent(e).substr(0,(d.end+f.length)).match(/(\r\n|\n|\r)/gm);d.start+=g.length;d.end+=g.length;if(a.getContent(e).substring(d.start,d.end).match(/(\r\n|\n|\r)/gm)){d.start++;d.end++}}}return d},setCursor:function(e,c){var d=a.getContent(e);if(!e.is("textarea")){var f=d.substr(0,c).match(/(\r\n|\n|\r)/gm);if(f!=null){c-=f.length}}e.selection(c,c)},getIframeInnards:function(c){return c.contentDocument||c.contentWindow.document},createPreview:function(d){var c={};c.el=b('<iframe class="markd-preview"></iframe>');b("body").prepend(c.el);c.innards=a.getIframeInnards(c.el[0]);c.innards.open();c.innards.write("");c.innards.close();c.head=b("head",c.innards);c.body=b("body",c.innards);c.head.append('<link rel="stylesheet" href="'+d+'" />');return c},deletePreview:function(c){if(c.el!=undefined){c.el.remove()}return c={}},insert:function(d,c,e){if(c>0){return d.substring(0,c)+e+d.substring(c,d.length)}else{return e+d}},open:function(c){var d=localStorage.getItem(c.attr("data-autosave-key"));if(d!=null){a.setContent(c,d)}},save:function(c,d){console.log("Fire save");localStorage.setItem(c,d)},clear:function(c){localStorage.removeItem(c)}};b.fn.markd=function(c){if(a[c]){return a[c].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof c==="object"||!c){return a.init.apply(this,arguments)}else{b.error("Method "+c+" does not exist on jQuery.markd")}}};b.fn.markd.defaults={autosave:true,theme:"preview.css",keyboardShortcuts:{bold:"ctrl+b",italic:"ctrl+i",code:"ctrl+k",link:"ctrl+l",help:"ctrl+h",preview:"ctrl+p",fullscreen:"ctrl+f"},parser:{pedantic:false,sanitize:false}}}(jQuery));