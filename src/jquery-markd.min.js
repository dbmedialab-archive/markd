(function(c){var b={init:function(d){return this.each(function(){var g=c(this);if(g.data("markd")===undefined){g.addClass("markd mousetrap");g.data("markd",c.extend({},c.fn.markd.defaults,d,{target:g,is_fullscreen:false,preview:{},offset:g.offset()}))}if(g.data("markd").autosave&&typeof(Storage)!=="undefined"&&g.attr("data-autosave-key")!=undefined){b.open.apply(g);g.data("markd").autosave=true}if(!g.is("textarea")){var e=g.html();b.setContent.apply(g,[e.replace(/(\r\n|\n|\r)/gm,"")])}g.data("markd").parser.compiler.setOptions({pedantic:g.data("markd").parser.pedantic,sanitize:g.data("markd").parser.sanitize});var f=g.data("markd");g.bind("focus",function(h){a.focus.apply(g)});g.bind("blur",function(h){a.blur.apply(g)})})},getContent:function(){var d=[];this.each(function(){var e=c(this);d.push(a.getContent.apply(e))});return d},setContent:function(d){return this.each(function(){var f=c(this),e=f.data("markd");if(f.is("textarea")){f.val(d)}else{d=d.replace(/(\r\n|\n|\r)/gm,"<br>");f.html(d)}})},setCursor:function(d){return this.each(function(){var g=c(this),e=a.getContent.apply(g);if(!g.is("textarea")){var f=e.substr(0,d).match(/(\r\n|\n|\r)/gm);if(f!=null){d-=f.length}}g.selection(d,d)})},getMarkdown:function(){var d=[];this.each(function(){var f=c(this),e=f.data("markd");d.push(e.parser.compiler(a.getContent.apply(f)))});return d},createPreview:function(d){return this.each(function(){var f=c(this),e={};if(d==undefined){d=f.data("markd").theme}e.el=c('<iframe class="markd-preview"></iframe>');c("body").prepend(e.el);e.innards=a.getIframeInnards(e.el[0]);e.innards.open();e.innards.write("");e.innards.close();e.head=c("head",e.innards);e.body=c("body",e.innards);e.head.append('<link rel="stylesheet" href="'+d+'" />');f.data("markd").preview=e})},deletePreview:function(){return this.each(function(){var e=c(this),d=e.data("markd");if(d.preview.el!=undefined){d.preview.el.remove()}e.data("markd").preview={}})},open:function(d){return this.each(function(){var f=c(this);if(d==undefined){d=f.attr("data-autosave-key")}var e=localStorage.getItem(d);if(e!=null){b.setContent.apply(f,[e])}})},save:function(d,e){return this.each(function(){var f=c(this);if(d==undefined){d=f.attr("data-autosave-key")}if(e==undefined){e=a.getContent.apply(f)}localStorage.setItem(d,e)})},clear:function(d){return this.each(function(){var e=c(this);if(d==undefined){d=e.attr("data-autosave-key")}localStorage.removeItem(d)})}};var a={focus:function(){var e=c(this),d=e.data("markd");if(d.autosave){e.bind("keyup",function(){b.save.apply(e)})}Mousetrap.bind("tab",function(){var g=a.getSelection.apply(e);var f=a.getContent.apply(e);f=a.insert(f,g.end,"\t");b.setContent.apply(e,[f]);b.setCursor.apply(e,[g.end+1]);return false});Mousetrap.bind(d.keyboardShortcuts.link,function(){var h=a.getSelection.apply(e);var g=a.getContent.apply(e);var f=g.substring(h.start,h.end).match(/(http|https|ftp):\/\//);if(f!=null){g=a.insert(g,h.end,")");g=a.insert(g,h.start,"[](");b.setContent.apply(e,[g]);b.setCursor.apply(e,[h.start+1])}else{g=a.insert(g,h.end,"]()");g=a.insert(g,h.start,"[");b.setContent.apply(e,[g]);b.setCursor.apply(e,[h.end+3])}return false});Mousetrap.bind(d.keyboardShortcuts.code,function(){var g=a.getSelection.apply(e);var f=a.getContent.apply(e);f=a.insert(f,g.end,"`");f=a.insert(f,g.start,"`");b.setContent.apply(e,[f]);b.setCursor.apply(e,[g.end+2]);return false});Mousetrap.bind(d.keyboardShortcuts.bold,function(){var g=a.getSelection.apply(e);var f=a.getContent.apply(e);f=a.insert(f,g.end,"__");f=a.insert(f,g.start,"__");b.setContent.apply(e,[f]);b.setCursor.apply(e,[g.end+4]);return false});Mousetrap.bind(d.keyboardShortcuts.italic,function(){var g=a.getSelection.apply(e);var f=a.getContent.apply(e);f=a.insert(f,g.end,"_");f=a.insert(f,g.start,"_");b.setContent.apply(e,[f]);b.setCursor.apply(e,[g.end+2]);return false});Mousetrap.bind(d.keyboardShortcuts.help,function(){window.open("http://daringfireball.net/projects/markdown/syntax","_blank");return false});Mousetrap.bind(d.keyboardShortcuts.preview,function(){if(!d.is_fullscreen){if(e.data("markd").preview.el==undefined){var f=e.offset();b.createPreview.apply(e);preview=e.data("markd").preview;preview.el.css({position:"absolute",top:f.top,left:f.left,width:e.outerWidth(),height:e.outerHeight()});preview.body.html(d.parser.compiler(a.getContent.apply(e)));Mousetrap.bind("esc",function(){b.deletePreview.apply(e);Mousetrap.unbind("esc")})}else{b.deletePreview.apply(e);Mousetrap.unbind("esc")}}return false});Mousetrap.bind(d.keyboardShortcuts.fullscreen,function(){if(!d.is_fullscreen){d.is_fullscreen=true;e.addClass("fullscreen");b.createPreview.apply(e);preview=e.data("markd").preview;preview.el.addClass("fullscreen");e.bind("keyup",function(f){preview.body.html(d.parser.compiler(a.getContent.apply(e)))});Mousetrap.bind("esc",function(){d.is_fullscreen=false;e.removeClass("fullscreen");e.unbind("keyup");Mousetrap.unbind("esc");b.deletePreview.apply(e)})}else{d.is_fullscreen=false;e.removeClass("fullscreen");e.unbind("keyup");Mousetrap.unbind("esc");b.deletePreview.apply(e)}return false})},blur:function(){var e=c(this),d=e.data("markd");if(d.autosave){e.unbind("keyup")}Mousetrap.unbind("tab");Mousetrap.unbind(d.keyboardShortcuts.bold);Mousetrap.unbind(d.keyboardShortcuts.italic);Mousetrap.unbind(d.keyboardShortcuts.link);Mousetrap.unbind(d.keyboardShortcuts.help);Mousetrap.unbind(d.keyboardShortcuts.preview);Mousetrap.unbind(d.keyboardShortcuts.fullscreen);if(!d.is_fullscreen){b.deletePreview.apply(e)}},insert:function(e,d,f){if(d>0){return e.substring(0,d)+f+e.substring(d,e.length)}else{return f+e}},getContent:function(){var e=c(this);if(e.is("textarea")){return e.val()}else{if(document.getElementById(e.attr("id")).innerText){var d=document.getElementById(e.attr("id")).innerText}else{var d=document.getElementById(e.attr("id")).textContent}d=d.replace(/\u00a0/g," ").replace(/&nbsp;/g," ");return d}},getSelection:function(){var g=c(this);var e=g.selection();if(!g.is("textarea")){var d=a.getContent.apply(g).substr(0,e.end);var f=d.match(/(\r\n|\n|\r)/gm);if(f!=null){var h=a.getContent.apply(g).substr(0,(e.end+f.length)).match(/(\r\n|\n|\r)/gm);e.start+=h.length;e.end+=h.length;if(a.getContent.apply(g).substring(e.start,e.end).match(/(\r\n|\n|\r)/gm)){e.start++;e.end++}}}return e},getIframeInnards:function(d){return d.contentDocument||d.contentWindow.document}};c.fn.markd=function(d){if(b[d]){return b[d].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof d==="object"||!d){return b.init.apply(this,arguments)}else{c.error("Method "+d+" does not exist on jQuery.markd")}}};c.fn.markd.defaults={autosave:true,theme:"preview.css",keyboardShortcuts:{bold:"ctrl+b",italic:"ctrl+i",code:"ctrl+k",link:"ctrl+l",help:"ctrl+h",preview:"ctrl+p",fullscreen:"ctrl+f"},parser:{compiler:window.marked,pedantic:false,sanitize:false}}}(jQuery));